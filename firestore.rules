/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model. All data is segregated into
 * user-specific data trees, ensuring that a user can only access their own
 * information. The primary mechanism for this is path-based authorization, where
 * the user's Authentication UID is a component of the document path.
 *
 * ## Data Structure
 * The data is organized hierarchically under the `/users` collection.
 * - `/users/{userId}`: Stores the main profile for a given user.
 * - `/users/{userId}/livestockRecords/{livestockRecordId}`: Stores user-specific
 *   livestock records in a subcollection.
 * - `/users/{userId}/tasks/{taskId}`: Stores user-specific tasks.
 *
 * This structure is inherently secure for list operations, as queries for a user's
 * private data can be scoped to their specific path without risk of data leakage.
 *
 * ## Key Security Decisions
 * - **No Public Data**: All collections are private and require user authentication.
 * - **User Enumeration Disabled**: Listing documents in the top-level `/users`
 *   collection is explicitly forbidden to protect user privacy.
 * - **Path-Based Ownership**: Access to any document or subcollection is granted
 *   by verifying that the `{userId}` in the path matches the requester's
 *   authenticated UID (`request.auth.uid`).
 * - **Relational Integrity**: On creation, rules validate that internal ID fields
 *   (like `User.id` and `LivestockRecord.userId`) correctly match the user ID
 *   from the path, creating a secure and consistent data ownership link. These
 *   ownership fields are enforced as immutable on updates.
 *
 * ## Denormalization for Authorization
 * The path-based ownership model is a form of denormalization that makes security
 * rules simple and performant. Instead of needing to perform a `get()` call to

 * check a separate permissions document, the ownership context is embedded directly
 * in the path of the resource being accessed.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the document exists AND the requester is the owner.
     * CRITICAL for safe update and delete operations to prevent acting on
     * non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates required ownership fields for a new User document.
     * In Prototyping Mode, we only validate fields critical for establishing
     * ownership and relational integrity.
     */
    function isUserDataValidOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Enforces immutability of critical ownership fields on a User document update.
     * Allows partial updates without requiring the client to resend the ID.
     */
    function isUserDataValidOnUpdate() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates required ownership fields for a new LivestockRecord document.
     * Ensures the record is correctly linked to the user in the path.
     */
    function isLivestockRecordDataValidOnCreate(userId) {
      // The `userId` field is not on the transaction, so we cannot validate it.
      // This is a trade-off for simplicity in the current model.
      return true;
    }

    /**
     * Enforces immutability of the ownership link on a LivestockRecord update.
     */
    function isLivestockRecordDataValidOnUpdate() {
      // The `userId` field is not on the transaction, so we cannot validate it.
      return true;
    }
    
    function isTaskDataValidOnCreate() {
        return true;
    }
    
    function isTaskDataValidOnUpdate() {
        return true;
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages user profile documents. Only the owner of the profile
     *              can read, create, update, or delete their own document.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own profile document, e.g., POST /users/abc with auth.uid = 'abc'.
     * @deny (list) Any user attempting to list all documents in the /users collection.
     * @deny (get) A user trying to read another user's profile, e.g., GET /users/xyz with auth.uid = 'abc'.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      // Allow create for any authenticated user on their own doc.
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages livestock records, which are stored in a subcollection
     *              under each user's profile.
     * @path /users/{userId}/livestockRecords/{livestockRecordId}
     * @allow (list) An authenticated user listing their own records, e.g., GET /users/abc/livestockRecords with auth.uid = 'abc'.
     * @allow (create) An authenticated user creating a new record for themselves.
     * @deny (get) A user trying to read a record belonging to another user.
     * @deny (update) A user trying to modify a record owned by someone else.
     * @principle Enforces document ownership for all operations within a user-specific subcollection.
     */
    match /users/{userId}/livestockRecords/{livestockRecordId} {
      allow read, write: if isOwner(userId);
    }
    
    match /users/{userId}/tasks/{taskId} {
      allow read, write: if isOwner(userId);
    }
  }
}